<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Configuration PIN</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f6f7f9;margin:16px;}
    .box{max-width:520px;margin:0 auto;background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    h1{text-align:center;margin:6px 0 14px;font-size:20px}
    label{display:block;margin:10px 0 6px;font-weight:800}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #d1d5db;font-size:14px}
    button{margin-top:14px;width:100%;padding:12px;border:0;border-radius:12px;background:#2563eb;color:#fff;font-weight:800;font-size:15px;cursor:pointer}
    .muted{color:#6b7280;font-size:12px;line-height:1.35;margin-top:10px}
    .status{margin-top:12px;text-align:center;color:#111827;font-weight:800}
    .err{margin-top:12px;text-align:center;color:#b91c1c;font-weight:800}
    a{color:#2563eb;text-decoration:none;font-weight:800}
  </style>
</head>
<body>
  <div class="box">
    <h1>Configuration des PIN</h1>

    <div class="muted">
      Cette page sert à créer <b>exactement 2 PIN</b> (toi + cheffe).<br>
      Une fois les deux créés, le setup est verrouillé et cette page devient inutile.
    </div>

    <label>API URL (Render)</label>
    <input id="api" placeholder="https://agrenad-backend.onrender.com" />

    <label>Setup secret (Render)</label>
    <input id="secret" placeholder="SETUP_SECRET" />

    <label>Créer quel PIN ?</label>
    <select id="role">
      <option value="owner">PIN 1 (toi)</option>
      <option value="chef">PIN 2 (cheffe)</option>
    </select>

    <label>PIN (4 chiffres)</label>
    <input id="pin" inputmode="numeric" maxlength="4" placeholder="1234" />

    <button onclick="setupPin()">Créer le PIN</button>

    <div id="status" class="status"></div>
    <div id="err" class="err"></div>

    <div class="muted" style="text-align:center;margin-top:14px;">
      <a href="index.html">Retour</a>
    </div>
  </div>

  <script>
    function setMsg(id, msg){ document.getElementById(id).textContent = msg || ""; }

    async function setupPin(){
      const API_URL = document.getElementById("api").value.trim();
      const setupSecret = document.getElementById("secret").value.trim();
      const role = document.getElementById("role").value;
      const pin = document.getElementById("pin").value.trim();

      setMsg("err","");
      setMsg("status","");

      if (!API_URL) return setMsg("err","API URL manquante.");
      if (!setupSecret) return setMsg("err","Setup secret manquant.");
      if (!/^\d{4}$/.test(pin)) return setMsg("err","PIN invalide (4 chiffres).");

      setMsg("status","Création…");

      const res = await fetch(`${API_URL}/api/pin/setup`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ setupSecret, role, pin })
      });

      const out = await res.json().catch(()=>({}));
      if (!res.ok) {
        setMsg("status","");
        return setMsg("err", out.error || `Erreur HTTP ${res.status}`);
      }

      setMsg("status","PIN créé ✅ (tu peux créer le second PIN maintenant)");
    }
  </script>
</body>
</html>
